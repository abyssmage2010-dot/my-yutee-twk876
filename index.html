<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Genshin Shatter: Fix</title>
    <style>
        body { text-align: center; background: #000; color: white; font-family: sans-serif; margin: 0; overflow: hidden; touch-action: none; user-select: none; }
        #menu, #winScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px; }
        .char-card { width: 90px; height: 90px; border: 2px solid #444; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border-radius: 8px; background: #222; color: #fff; text-transform: uppercase; text-align: center; padding: 5px; box-sizing: border-box; }
        .selected-p1 { border-color: #00ffff !important; box-shadow: 0 0 10px #00ffff; }
        .selected-p2 { border-color: #ff0000 !important; box-shadow: 0 0 10px #ff0000; }
        #start-btn { margin-top: 20px; padding: 15px 40px; background: #a00; color: white; border: none; font-size: 20px; display: none; border-radius: 5px; cursor: pointer; }
        canvas { display: block; width: 100vw; height: 50vh; background: #000; border-bottom: 3px solid #333; }
        .ui { display: flex; justify-content: space-around; padding: 5px; background: #000; height: 30px; }
        .health-bar { width: 45%; height: 15px; background: #333; border: 1px solid #fff; }
        .health-inner { height: 100%; width: 100%; background: #f00; transition: 0.1s; }
        .controls { display: flex; justify-content: space-between; padding: 10px; height: 40vh; align-items: center; background: #111; }
        .btn { width: 70px; height: 70px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 25px; color: white; border: 1px solid #555; cursor: pointer; }
        #btn-atk { background: #600; width: 100px; height: 100px; color: #f44; font-weight: bold; }
        #winScreen { display: none; }
    </style>
</head>
<body>

    <div id="menu">
        <h3 id="menu-hint">SELECT YOUR FIGHTER</h3>
        <div class="grid" id="charGrid"></div>
        <button id="start-btn" onclick="initGame()">COMMENCE FIGHT</button>
    </div>

    <div id="winScreen">
        <h1 style="color:red; font-size: 40px;">FATALITY</h1>
        <button onclick="location.reload()" style="padding:15px 30px; background: red; color:white; border:none; cursor:pointer;">REMATCH</button>
    </div>

    <div class="ui">
        <div class="health-bar"><div id="p1-hp" class="health-inner" style="background: #00ffff;"></div></div>
        <div class="health-bar"><div id="p2-hp" class="health-inner"></div></div>
    </div>

    <canvas id="gameCanvas" width="800" height="400"></canvas>

    <div class="controls">
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
            <div></div> <div class="btn" id="btn-up">↑</div> <div></div>
            <div class="btn" id="btn-left">←</div> <div></div> <div class="btn" id="btn-right">→</div>
        </div>
        <div class="btn" id="btn-atk">ATTACK</div>
    </div>

    <script>
        // UPDATED ROSTER WITH NEW IMAGE LINKS
        const ROSTER = {
            "mualani": { 
                name: "Mualani", 
                hp: 100, 
                pwr: 9, 
                color: "#00ccff", 
                url: "https://static.wikia.nocookie.net/gensin-impact/images/7/73/Mualani_Portrait.png/revision/latest/scale-to-width-down/250" 
            },
            "dehya": { 
                name: "Dehya", 
                hp: 120, 
                pwr: 12, 
                color: "#ffaa00", 
                url: "https://upload.wikimedia.org/wikipedia/en/2/22/Dehya_%28Genshin_Impact%29.png" 
            },
            "hutao": { 
                name: "Hu Tao", 
                hp: 90, 
                pwr: 14, 
                color: "#ff4400", 
                url: "https://upload.wikimedia.org/wikipedia/en/b/b2/Hu_Tao_%28Genshin_Impact%29.png" 
            },
            "nilou": { name: "Nilou", hp: 100, pwr: 10, color: "#00ffff", url: "https://paimon.moe/images/characters/full/nilou.png" },
            "yae": { name: "Yae Miko", hp: 100, pwr: 11, color: "#ff00ff", url: "https://paimon.moe/images/characters/full/yae-miko.png" }
        };

        let p1Key = null, p2Key = null;
        const grid = document.getElementById('charGrid');
        
        Object.keys(ROSTER).forEach(key => {
            let div = document.createElement('div');
            div.className = 'char-card';
            div.innerText = ROSTER[key].name;
            div.onclick = () => {
                if (!p1Key) { p1Key = key; div.classList.add('selected-p1'); }
                else if (!p2Key && key !== p1Key) { p2Key = key; div.classList.add('selected-p2'); document.getElementById('start-btn').style.display = 'block'; }
            };
            grid.appendChild(div);
        });

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let p1, p2, particles = [], fatality = false, gameActive = false, shake = 0;
        const keys = {};

        function setupBtn(id, key) {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
            el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
            // Support for mouse clicks for testing on PC
            el.addEventListener('mousedown', () => { keys[key] = true; });
            el.addEventListener('mouseup', () => { keys[key] = false; });
        }
        setupBtn('btn-up', 'w'); setupBtn('btn-left', 'a'); setupBtn('btn-right', 'd'); setupBtn('btn-atk', 's');

        class Fighter {
            constructor(x, data, side) {
                this.x = x; this.y = 140; this.hp = data.hp; this.maxHp = data.hp;
                this.pwr = data.pwr; this.color = data.color; this.side = side;
                this.vy = 0; this.loaded = false;
                this.img = new Image();
                this.img.crossOrigin = "anonymous"; // Helps with canvas issues
                this.img.onload = () => { this.loaded = true; };
                this.img.src = data.url;
            }
            update(opp) {
                if (fatality) return;
                if (this.side === 'left') {
                    if (keys['a']) this.x -= 7;
                    if (keys['d']) this.x += 7;
                    if (keys['w'] && this.y === 140) this.vy = -18;
                    if (keys['s'] && !this.cd) {
                        this.cd = true;
                        if (Math.abs(this.x - opp.x) < 120) {
                            opp.hp -= this.pwr; shake = 20;
                            for(let i=0; i<20; i++) particles.push({x:opp.x+80, y:opp.y+100, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15, life:1});
                            document.getElementById(opp.side === 'left' ? 'p1-hp' : 'p2-hp').style.width = Math.max(0, (opp.hp / opp.maxHp * 100)) + "%";
                            if (opp.hp <= 0) { fatality = true; setTimeout(()=>document.getElementById('winScreen').style.display='flex', 3000); }
                        }
                        setTimeout(() => this.cd = false, 300);
                    }
                } else { // AI logic
                    if (this.x > opp.x + 100) this.x -= 4;
                    else if (this.x < opp.x - 100) this.x += 4;
                    else if (Math.random() > 0.98) {
                        opp.hp -= 5;
                        document.getElementById('p1-hp').style.width = Math.max(0, (opp.hp / opp.maxHp * 100)) + "%";
                        if (opp.hp <= 0) location.reload();
                    }
                }
                this.vy += 0.8; this.y += this.vy;
                if (this.y > 140) { this.y = 140; this.vy = 0; }
                // Constrain to screen
                if (this.x < 0) this.x = 0;
                if (this.x > 640) this.x = 640;
            }
            draw() {
                if (this.hp <= 0 && fatality) {
                    ctx.fillStyle = "red";
                    ctx.font = "20px Arial";
                    ctx.fillText("CRUSHED", this.x + 80, this.y + 100);
                    return;
                }
                if (this.loaded) {
                    ctx.drawImage(this.img, this.x, this.y, 160, 240);
                } else {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.x, this.y + 40, 100, 200);
                }
            }
        }

        function initGame() {
            document.getElementById('menu').style.display = 'none';
            p1 = new Fighter(100, ROSTER[p1Key], 'left');
            p2 = new Fighter(500, ROSTER[p2Key], 'right');
            gameActive = true;
            loop();
        }

        function loop() {
            if (!gameActive) return;
            ctx.clearRect(0, 0, 800, 400);
            
            if (shake > 0) { 
                ctx.save();
                ctx.translate(Math.random()*shake, Math.random()*shake); 
                shake *= 0.9; 
            }

            particles = particles.filter(p => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                ctx.fillStyle = `rgba(255,0,0,${p.life})`;
                ctx.fillRect(p.x, p.y, 5, 5);
                return p.life > 0;
            });

            p1.update(p2); p2.update(p1);
            p1.draw(); p2.draw();

            if (fatality) {
                ctx.fillStyle = "red"; ctx.font = "60px Impact"; ctx.textAlign = "center";
                ctx.fillText("FATALITY", 400, 200);
            }

            if (shake > 0) ctx.restore();
            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>